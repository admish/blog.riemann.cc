<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux | Worth Mentioning]]></title>
  <link href="http://blog.riemann.cc/categories/linux/atom.xml" rel="self"/>
  <link href="http://blog.riemann.cc/"/>
  <updated>2013-10-09T01:12:28+02:00</updated>
  <id>http://blog.riemann.cc/</id>
  <author>
    <name><![CDATA[Robert Riemann]]></name>
    <email><![CDATA[robert@riemann.cc]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Automatically Login to wifi.free.fr Wifi]]></title>
    <link href="http://blog.riemann.cc/2013/10/09/automatically-login-to-wifi-dot-free-dot-fr-wifi/"/>
    <updated>2013-10-09T00:46:00+02:00</updated>
    <id>http://blog.riemann.cc/2013/10/09/automatically-login-to-wifi-dot-free-dot-fr-wifi</id>
    <content type="html"><![CDATA[<p>The not so expansive French mobile phone operator <a href="http://www.free.fr">free.fr</a> offers
some nice extras for their clients. People can use the free.fr hotspots, which
you can find at many places in French cities.</p>

<p>I’m one of these lucky guys who can actually receive this hotspot in the own flat.
So why should I pay extra for cable internet?</p>

<p>To still have some selling points for ADSL customers free.fr doesn’t make it very
convenient to use this free wifi. The network comes without any security modes like 
WPA/WPA2/WAP, but requires you to authenticate yourself an a gateway page every time
you reconnect to the network. There is only one other option which incorporates SIM card
authentication which is not an option for most computers due to the lack of a SIM card.</p>

<p>So why not using <code>curl</code> to send automatically an POST request with your login data
as soon as you got connected to the so-called “FreeWifi” network?</p>

<p>Using openSuSE 12.3 or any other Linux distribution based on NetworkManager you
just place the following file <code>freewifi-up</code> in <code>/etc/NetworkManager/dispatcher.d</code>.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>/etc/NetworkManager/dispatcher.d/freewifi-up </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/sh</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># auto login freewifi from free.fr</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>. /etc/rc.status&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;case “<span class="nv">$2</span>” in
</span><span class='line'>    up<span class="o">)</span>
</span><span class='line'>        <span class="k">if </span>iwgetid | grep -qs :<span class="s2">&quot;FreeWifi&quot;</span>; <span class="k">then</span>
</span><span class='line'><span class="k">                </span>curl -s -X POST -d ‘login<span class="o">=</span>000000000&amp;amp;password<span class="o">=</span>mypassword&amp;amp;submit<span class="o">=</span>Valider’ https://wifi.free.fr/Auth
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>        ;;
</span><span class='line'>    *<span class="o">)</span>
</span><span class='line'>        <span class="nb">exit </span>0
</span><span class='line'>        ;;
</span><span class='line'><span class="k">esac</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The actual name of the file is not very important. But pay attention to set the
appropiate file rights <code>chmod 755 freewifi-up</code>. Of course, you have to replace
the login number and the password by your own.</p>

<p>The script will be run by networkmanager automatically when the connection status
get changed. Only if a connection was setup the wifi SSID will be checked to be
<code>FreeWifi</code>. Only In this case an authentication request will be send to the gateway webpage.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Gitlab on OpenSUSE 12.3]]></title>
    <link href="http://blog.riemann.cc/2013/05/01/install-gitlab-on-opensuse-12.3/"/>
    <updated>2013-05-01T22:59:00+02:00</updated>
    <id>http://blog.riemann.cc/2013/05/01/install-gitlab-on-opensuse-12.3</id>
    <content type="html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#private-git-repo-hosting">Private Git Repo Hosting</a></li>
  <li><a href="#install-os">Install OS</a></li>
  <li><a href="#install-gitlab">Install Gitlab</a></li>
  <li><a href="#install-dependencies">Install dependencies:</a>    <ul>
      <li><a href="#prepare-system-for-gitlab">Prepare system for Gitlab</a></li>
      <li><a href="#prapare-gitlab-using-account-git">Prapare Gitlab (using account git)</a></li>
    </ul>
  </li>
</ul>

<h3 id="private-git-repo-hosting">Private Git Repo Hosting</h3>

<p><a href="http://gitlab.org/">Gitlab</a> brings the social coding <a href="http://www.github.com/">Github</a> experience to your own network. In
contrast to the commercial product Github which only allows to host open source
<a href="http://git-scm.com/">git</a> repository projects using the free plan, you can install the free/libre software Gitlab
wherever you like and do what you want.
Therefore you need to setup a RubyOnRails environment.
Officially, Gitlab supports Debian/Ubuntu.
Read on how to install it on <a href="http://www.opensuse.org/">OpenSUSE</a>.</p>

<!-- more -->

<p>The presented solutions features a btrfs
filesystem RAID-1 <code>:)</code> and some custom patches. Instead of init.d startup scripts,
we use systemd. I recommend to use nginx as a webserver.</p>

<p>Please be aware that the development of Gitlab continues rapidly. This might break
this how-to at some point. Please read everything before starting!</p>

<h3 id="install-os">Install OS</h3>

<ul>
  <li>Download OpenSUSE 12.3 32bit, Network edition
<a href="http://download.opensuse.org/distribution/12.3/iso/openSUSE-12.3-NET-i586.iso">http://download.opensuse.org/distribution/12.3/iso/openSUSE-12.3-NET-i586.iso</a></li>
  <li>I chose 32bit, because Ruby Binary Extensions might have problems with lib64 path structure. We workaround this bug.</li>
  <li>I chose networkinstall, because we need only very few packages and don’t need to download everything. only 200MB are downloaded during install</li>
  <li>the image can easily copied to a usb pen drive using the gui tool “imagewriter” (executed as root)</li>
  <li>Partition: There are 2 big hard drives. I created on both of them first a primary pratition of 1GB of type LINUX-RAID</li>
  <li>I use the yast software raid setup during the install to connect both partitions to a software raid-1 partititon of ext4 to mount in /boot</li>
  <li>I created on both hard drives a btrfs partition (50GB), but only mount the one on /dev/sda to /</li>
  <li>I created on both hard drives a swap space of 2 GB and mount both to swap</li>
</ul>

<p>The system gets installed and the configuration follows.</p>

<ul>
  <li>I open ssh. I disable ipv6.</li>
  <li>I disable dhcp and configure the hostname to “leise” and the site to our internet domain, the nameserver and the gateway is set to be the mail server.</li>
  <li>The server gets the fixed ip: 192.xxx.xxx.184</li>
  <li>The network check passes successfully and I apply immedately online updates.</li>
  <li>I leave the user input dialog blank and only set a root password</li>
</ul>

<p>The installation is done. I test everything with a restart using <code>reboot</code>.
Now the root filesystem has to be turned to a btrfs raid system.</p>

<ul>
  <li>I add a second device to the root file system: <code>btrfs device add /dev/sdb2 /</code></li>
  <li>I convert the striped btrfs mode to the raid1 mode for filesystem data and metadata:
<code>btrfs filesystem balance start -dconvert=raid1 -mconvert=raid1 /</code></li>
</ul>

<h3 id="install-gitlab">Install Gitlab</h3>

<ul>
  <li>Homepage: <a href="http://gitlab.org/">http://gitlab.org/</a></li>
  <li>Source Code: <a href="https://github.com/gitlabhq/gitlabhq">https://github.com/gitlabhq/gitlabhq</a></li>
</ul>

<p>The following steps apply to version 5.0 and try to copy the step by step
tutorial which is refered from the README:
<a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md">https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md</a></p>

<h2 id="install-dependencies">Install dependencies:</h2>

<pre><code>zypper ar http://download.opensuse.org/repositories/devel:/languages:/ruby:/extensions/openSUSE_12.3/devel:languages:ruby:extensions.repo

zypper in patterns-openSUSE-devel_basis ca-certificates-cacert nginx rubygem-rb-inotify rubygem-ffi redis mysql-community-server mysql-community-server-client rubygem-bundler ruby19 ruby19-devel libmysqlclient-devel zlib-devel libyaml-devel libgdbm4 libreadline6 libncurses5 libffi47-devel curl git-core postfix checkinstall libxml2-devel libxslt-devel libcurl-devel libicu-devel
# accept deinstallation of patterns-openSUSE-minimal_base-conflicts

python2 --version # make sure to have version &gt; 2.5 but &lt; 3.0

ruby1.9 --version # make sure to have a compatible version (in my case 1.9.3)
cat /usr/bin/bundle # make sure to have ruby version 1.9 in the shebang line (first line in file)

systemctl daemon-reload # reparse config for systemd (necessary, because we installed mysql)
systemctl start mysql.service  # start mysql
systemctl enable mysql.service # make mysql autostart
cp /etc/redis/default.conf{.example,}
chown redis.redis /etc/redis/default.conf
systemctl enable redis.service
systemctl start redis.service
</code></pre>

<h4 id="prepare-system-for-gitlab">Prepare system for Gitlab</h4>

<ul>
  <li>create a user git: <code>useradd -ms /bin/bash git</code></li>
</ul>

<h4 id="prapare-gitlab-using-account-git">Prapare Gitlab (using account git)</h4>

<pre><code>su git # (change to the account of git)
cd # (change to the home directory /home/git)
git clone https://github.com/gitlabhq/gitlab-shell.git
cd gitlab-shell
cp config.yml.example config.yml
vim config.yml # change domain to the domain of this computer
cd
ssh-keygen # to be sure, create ssh key (not mentioned in official docu) with empty passphrase
</code></pre>

<p>Follow the setup of the mysql data base: <a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/databases.md#mysql">https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/databases.md#mysql</a></p>

<ul>
  <li><code>mysql -u root</code></li>
  <li>follow the guide for mysql commands</li>
</ul>

<p>We continue with the setup of the GitLab Rails application:</p>

<pre><code>gem1.9 install charlock_holmes --version '0.6.9' # execute as root
su git
cd
git clone https://github.com/gitlabhq/gitlabhq.git gitlab
cd gitlab
git checkout 5-0-stable # not possible yet, I use master instead
vim config/gitlab.yml
# ^- email_from: gitlab@atech.de, support_email: admin@atech.de, default_projects_limit: 100
# disable username_changing_enabled
chown -R git log/ tmp/
chmod -R u+rwX log/ tmp/
mkdir /home/git/gitlab-satellites
mkdir tmp/pids/
chmod -R u+rwX tmp/pids/
cp config/unicorn.rb.example config/unicorn.rb
cp config/database.yml.mysql config/database.yml
vim config/database.yml # edit password and username
bundle install --deployment --without development test postgres # takes a while
bundle exec rake db:setup RAILS_ENV=production
bundle exec rake db:seed_fu RAILS_ENV=production
bundle exec rake gitlab:setup RAILS_ENV=production # chose yes
bundle exec rake gitlab:shell:setup RAILS_ENV=production # chose yes
git config --global user.name  "GitLab"
git config --global user.email "gitlab@atech.de"
</code></pre>

<p>Install Check:</p>

<pre><code>su git
cd /home/git/gitlab
bundle exec rake gitlab:check RAILS_ENV=production
</code></pre>

<p>Go to yast firewall and open port http (and https port): 80, (443)</p>

<pre><code># update services
su
cd /usr/lib/systemd/system/
wget https://gist.github.com/veprbl/5115638/raw/9d18a341217f109accb67f57e8ad420c9de442fd/gitlab.service # TODO wrong mysqld
wget https://gist.github.com/veprbl/5115638/raw/be78658953cd5967a4d874f5b0a019667cf090af/gitlab-worker.service # TODO same
# double-check content of these files!
chmod 644 gitlab.service gitlab-worker.service
# TODO edit /etc/nginx/vhost.d/*
systemctl daemon-reload
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Versioning of OpenOffice/LibreOffice documents using git]]></title>
    <link href="http://blog.riemann.cc/2013/04/23/versioning-of-openoffice-libreoffice-documents-using-git/"/>
    <updated>2013-04-23T08:38:00+02:00</updated>
    <id>http://blog.riemann.cc/2013/04/23/versioning-of-openoffice-libreoffice-documents-using-git</id>
    <content type="html"><![CDATA[<p>At the moment I’m preparing my application documents for my job after finishing
my travels. Of course, I track changes of my LaTeX documents with the <a href="http://git-scm.com">git</a>
versioning system. This is pretty straight-forward, because LaTeX documents are
only plain text.</p>

<p>Beside this, I’m using as well some <a href="http://www.libreoffice.org/">LibreOffice</a> (compatible to OpenOffice)
documents, whose changes are not obvious as it uses a binary format. For sure, git
can handle binary files, but the log is not really helpfull.</p>

<pre><code>Binary files "a/overview.ods" and "b/overview.ods" differ
</code></pre>

<p>Since git version 1.6.1 or later, you can specify dedicated diff filters per
file extensions to track these files as well as plain text files.</p>

<!-- more -->

<p>Knowing that files <a href="http://en.wikipedia.org/wiki/OpenDocument">OpenDocument</a> files <code>*.ods</code>, <code>*.odt</code> or <code>*.odp</code> are only gziped folders of xml
files, it is perfectly obvious to extract the files before comparision. This way,
a plain text diff can be done. I’m using <a href="http://stosberg.net/odt2txt/">odt2txt</a>, which is available in the
openSUSE software archive.</p>

<p>Unfortunately, the whole file content is presented in one single, very long text
line. As git is based on tracking changing lines, this is not very helpfull. So
I decided to use additionally an XML file formatter (xmllint is already installed)
to solve this problem.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>OpenDocument Git Filter – ~/bin/odf2prettytxt </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env sh</span>
</span><span class='line'><span class="c"># place this file to ~/bin/odf2prettytxt and have ~/bin in $PATH</span>
</span><span class='line'><span class="nb">set</span> -o errexit
</span><span class='line'>/usr/bin/odt2txt –raw “<span class="nv">$@</span>” | /usr/bin/xmllint –format -
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This filter must be announced to your git installation</p>

<pre><code>git config --global diff.odf.textconv "odf2prettytxt"
</code></pre>

<p>Lastly you can enable this filter per project/folder by adding a line to your
<code>.gitattributes</code> file. This is done for the <code>*.ods</code> files using this one liner.</p>

<pre><code>echo '*.ods diff=odf' &gt;&gt; .gitattributes
</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Patching Ruby Gem GSL]]></title>
    <link href="http://blog.riemann.cc/2013/01/05/patching-ruby-gsl/"/>
    <updated>2013-01-05T14:21:00+01:00</updated>
    <id>http://blog.riemann.cc/2013/01/05/patching-ruby-gsl</id>
    <content type="html"><![CDATA[<p>The <a href="http://gist.github.com/">Github Gist</a> code pasting service received
some updates, which breaks the layout of the embedding tags used by this blogging
engine octopress (<a href="http://github.com/imathis/octopress/issues/847">Issue #847</a>).</p>

<p>This issue was already fixed and got included in the development branch 2.1.
I decided to upgrade my blog to the latest development version. Afterwards the
Ruby version manager <a href="http://rvm.io/">rvm</a> asked to install a new ruby version.
To meet the exact requirements of octopress I decided to give it a run, but when
installing the required gems using <code>bundle install</code> I wasn’t able to
install <a href="http://rb-gsl.rubyforge.org/">gsl</a>, the ruby binding to the GNU
scientific library, which is used to speed-up the “related posts” calculation.
I remembered to run into this problem once before. Unfortunately it isn’t
resolved yet. <code>:(</code></p>

<pre><code>vector_complex.c:1989:12: error: conflicting types for 'gsl_vector_complex_equal'
/usr/include/gsl/gsl_vector_complex_double.h:167:5: note: previous declaration of 'gsl_vector_complex_equal' was here
make: *** [vector_complex.o] Error 1
</code></pre>

<!-- more -->

<h3 id="solution">Solution</h3>

<p>To get this gem installed nevertheless, you have to patch the sources of the
native extension. For this, you have to find the building directory <code>ext</code>, which
should be mentioned in the error message.</p>

<p>Put the patch <code>rb-gsl.patch</code> from below in this directory or download it using</p>

<pre><code>wget 'https://gist.github.com/raw/2296214/c6b1c7150713da5d2640ddc799132611ac72cef4/rb-gsl.patch'
</code></pre>

<p>Then you have to apply the patch using <code>patch -p2 &lt; rb-gsl.patch</code> from within the
<code>ext</code> directory. To build the extension finally, you have to run the command
<code>make -j4</code>. If you proceed with bundle install again, the source code will be unzipped
again leaving you with same unpatched code as before. To work around this issue,
a hint is given in the help of the gem install commmand (<code>gem install --help</code>).</p>

<pre><code>If you correct the compilation errors by editing the gem files you will need
    to write the specification by hand.  For example:

      $ gem install some_extension_gem
      [build fails]
      Gem files will remain installed in \
      /path/to/gems/some_extension_gem-1.0 for inspection.
      Results logged to /path/to/gems/some_extension_gem-1.0/gem_make.out
      $ [cd /path/to/gems/some_extension_gem-1.0]
      $ [edit files or what-have-you and run make]
      $ gem spec ../../cache/some_extension_gem-1.0.gem --ruby &gt; \
                ../../specifications/some_extension_gem-1.0.gemspec
      $ gem list some_extension_gem
</code></pre>

<p>So I just did as I got told (still in <code>exe</code> directory):</p>

<pre><code> gem spec ../../../cache/gsl-1.14.7.gem --ruby &gt; ../../../specifications/gsl-1.14.7.gemspec
</code></pre>

<p>Afterwards <code>bundle install</code> will accept this gem. That’s it!</p>

<h3 id="patch-rb-gslpatch">Patch rb-gsl.patch</h3>

<p><div><script src='https://gist.github.com/2296214.js?file=rb-gsl.patch'></script>
<noscript><pre><code>diff --git a/ext/matrix_complex.c b/ext/matrix_complex.c
index 8a77ac1..1b1d8af 100644
--- a/ext/matrix_complex.c
+++ b/ext/matrix_complex.c
@@ -1519,8 +1519,7 @@ static VALUE rb_gsl_matrix_complex_indgen_singleton(int argc, VALUE *argv, VALUE
   return Data_Wrap_Struct(cgsl_matrix_complex, 0, gsl_matrix_complex_free, mnew);
 }
 
-
-static int gsl_matrix_complex_equal(const gsl_matrix_complex *m1,
+static int gsl_matrix_complex_equal_witg_eps(const gsl_matrix_complex *m1,
   const gsl_matrix_complex *m2, double eps)
 {
   gsl_complex z1, z2;
@@ -1537,6 +1536,7 @@ static int gsl_matrix_complex_equal(const gsl_matrix_complex *m1,
   return 1;
 }
 
+
 static VALUE rb_gsl_matrix_complex_equal(int argc, VALUE *argv, VALUE obj)
 {
   gsl_matrix_complex *m1, *m2;
@@ -1555,7 +1555,7 @@ static VALUE rb_gsl_matrix_complex_equal(int argc, VALUE *argv, VALUE obj)
   Data_Get_Struct(obj, gsl_matrix_complex, m1);
   CHECK_MATRIX_COMPLEX(argv[0]);
   Data_Get_Struct(argv[0], gsl_matrix_complex, m2);
-  ret = gsl_matrix_complex_equal(m1, m2, eps);
+  ret = gsl_matrix_complex_equal_witg_eps(m1, m2, eps);
   if (ret == 1) return Qtrue;
   else return Qfalse;
 }
diff --git a/ext/vector_complex.c b/ext/vector_complex.c
index f9a84f0..2711a36 100644
--- a/ext/vector_complex.c
+++ b/ext/vector_complex.c
@@ -1986,7 +1986,7 @@ static VALUE rb_gsl_vector_complex_zip(int argc, VALUE *argv, VALUE obj)
   return ary;
 }
 
-static int gsl_vector_complex_equal(const gsl_vector_complex *v1,
+static int gsl_vector_complex_equal_with_eps(const gsl_vector_complex *v1,
   const gsl_vector_complex *v2, double eps)
 {
   gsl_complex z1, z2;
@@ -2019,7 +2019,7 @@ static VALUE rb_gsl_vector_complex_equal(int argc, VALUE *argv, VALUE obj)
   Data_Get_Struct(obj, gsl_vector_complex, v1);
   CHECK_VECTOR_COMPLEX(argv[0]);
   Data_Get_Struct(argv[0], gsl_vector_complex, v2);
-  ret = gsl_vector_complex_equal(v1, v2, eps);
+  ret = gsl_vector_complex_equal_with_eps(v1, v2, eps);
   if (ret == 1) return Qtrue;
   else return Qfalse;
 }</code></pre></noscript></div>
</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[self-made router-powered repository mirror]]></title>
    <link href="http://blog.riemann.cc/2012/07/23/selfmade-repository-mirror/"/>
    <updated>2012-07-23T01:32:00+02:00</updated>
    <id>http://blog.riemann.cc/2012/07/23/selfmade-repository-mirror</id>
    <content type="html"><![CDATA[<p>After migrating most desktop PCs at work, at home and of some friends to
<a href="http://www.opensuse.org/">openSUSE</a> with <a href="http://en.opensuse.org/KDE_repositories#Upstream_release_aka._KR48_.28KDE_SC_4.8.29">upstream KDE repo</a>, it was always a
time-consuming task to keep all these systems up-to-date. I was most
bothered by downloading the same files over and over again, which happened
sometimes to be quite slow, especially via WLAN.</p>

<p>Fortunatly I got a couple of month ago the Linux-based router <a href="http://en.wikipedia.org/wiki/FRITZ!Box">AVM Fritz!Box 7270</a>,
which can be rooted with a modified firmware. The customizable firmware is
provided by the <a href="http://freetz.org/">Freetz</a> project and allows you to combine different
modular packages to add functionality.</p>

<!-- more -->

<p>After playing a little bit with Freetz, I even got a lighttpd webserver with
ruby and caching capabilities running. Of course, the original firmware as well
as Freetz allow the configuration of dynamic DNS services. <code>;)</code></p>

<p>I ended up with a configuration including:</p>

<ul>
  <li>dropbear ssh server (allows remote login via ssh – otherwise only telnet is supported)</li>
  <li>automount-scripts supporting ext3 and ext4 (latter is not supported by AVM firmware)</li>
  <li>nfs including a CGI configuration web page</li>
  <li>rsync</li>
</ul>

<p>I formatted an external hard drive to use ext4 and attached it to the router.
The file <code>mirror-rsync.sh</code> needs to be copied to an arbitrary folder on the
external drive.</p>

<p><div><script src='https://gist.github.com/1729496.js?file=mirror-rsync.sh'></script>
<noscript><pre><code>#!/bin/sh
set -o errexit

cd /var/media/ftp/uStor02/opensuse

echo -e &quot;\nII: Start time: $(date)\nII: directory: $(pwd)&quot; 2&gt;&amp;1 | tee -a log.txt

trap - INT

# rsync -vaH --delete --delete-after --progress --partial --size-only --delay-updates --include-from=include.txt --exclude-from=exclude.txt --timeout=300 ftp-1.gwdg.de::pub/opensuse/update/12.1/ update/12.1 2&gt;&amp;1 | tee -a log.txt
rsync -vaH --delete --delete-after --progress --partial --size-only --delay-updates --include-from=include.txt --exclude-from=exclude.txt --timeout=300 ftp.halifax.rwth-aachen.de::opensuse/update/12.1/ update/12.1 2&gt;&amp;1 | tee -a log.txt

# rsync -vaH --delete --delete-after --progress --partial --size-only --delay-updates --include-from=include.txt --exclude-from=exclude.txt --timeout=300 ftp5.gwdg.de::pub/opensuse/repositories/KDE:/Release:/48/openSUSE_12.1/ repositories/KDE:/Release:/48/openSUSE_12.1 2&gt;&amp;1 | tee -a log.txt
rsync -vaH --delete --delete-after --progress --partial --size-only --delay-updates --include-from=include.txt --exclude-from=exclude.txt --timeout=300 ftp.halifax.rwth-aachen.de::opensuse/repositories/KDE:/Release:/48/openSUSE_12.1/ repositories/KDE:/Release:/48/openSUSE_12.1 2&gt;&amp;1 | tee -a log.txt

rsync -vaH --delete --delete-after --progress --partial --size-only --delay-updates --include-from=include.txt --exclude-from=exclude.txt --timeout=300 packman.inode.at::packman/suse/12.1/Essentials/ repositories/packman/12.1/Essentials 2&gt;&amp;1 | tee -a log.txt
</code></pre></noscript></div>
</p>

<p>To lower the data transfer, I tuned my rsync commands to download only
x86_64 packages as well as only German language packages.</p>

<p><div><script src='https://gist.github.com/1729496.js?file=include.txt'></script>
<noscript><pre><code>*l10n-de*x86_64*
*l10n-de*noarch*
*wine*

*libqt4-debuginfo*x86_64*
*libkdepimlibs4-debuginfo*x86_64*
*libkdecore4-debuginfo*x86_64*
*libkde4-debuginfo*x86_64*
*kdepim4-debuginfo*x86_64*
*libqt4-x11-debuginfo*x86_64*
*amarok-debuginfo*x86_64*
*kmail-debuginfo*x86_64*
*libakonadi4-debuginfo*x86_64*</code></pre></noscript></div>

<div><script src='https://gist.github.com/1729496.js?file=exclude.txt'></script>
<noscript><pre><code>src
*i686.rpm
*i686.drpm
*i586.rpm
*i586.drpm
*buildsymbols*
ia64
*debuginfo*
*debugsource*
*l10n*</code></pre></noscript></div>
</p>

<p>To finish the router setup, the only thing left is to add a Cron job (supported by
Freetz interface) which runs the script daily – preferably during the night.</p>

<p>The original firmware provides SMB access to files on the hard drive. This can be
quite slow. So I configured NFS for access these repositories. There’s a
<a href="http://linuxundich.de/de/hardware/dateifreigaben-auf-der-fritzbox-via-nfs-und-freetz/">German blog post</a> with some benchmarks to compare SMB and NFS.</p>

<p>Finally, the new repositories have to be activated. The priority is set to 90
and this way overranks the original repos, which don’t have to be disabled.</p>

<p><div><script src='https://gist.github.com/1729496.js?file=client.sh'></script>
<noscript><pre><code>#!/bin/sh

zypper ar --check --no-keep-packages --no-gpgcheck --type rpm-md --name fritzbox-12.1-update nfs://fritz.box:/var/media/ftp/uStor02/opensuse/update/12.1?mountoptions=vers=3 fritzbox-12.1-update
zypper ar --check --no-keep-packages --no-gpgcheck --type rpm-md --name fritzbox-12.1-kde48 nfs://fritz.box:/var/media/ftp/uStor02/opensuse/repositories/KDE:/Release:/48/openSUSE_12.1?mountoptions=vers=3 fritzbox-12.1-kde48
zypper ar --check --no-keep-packages --no-gpgcheck --type rpm-md --name fritzbox-12.1-packman nfs://fritz.box:/var/media/ftp/uStor02/opensuse/repositories/packman/12.1/Essentials?mountoptions=vers=3 fritzbox-12.1-packman

zypper mr -p 90 fritzbox-12.1-update
zypper mr -p 90 fritzbox-12.1-kde48
zypper mr -p 90 fritzbox-12.1-packman</code></pre></noscript></div>
</p>

<p>The most important thing is here to append <code>?mountoptions=vers=3</code> to all URLs.
The Freetz NFS build doesn’t support NFS version 4 and zypper fails to auto-detect
this.</p>

<p>So the next time I want to bring the latest KDE release to a friend, I just have
to unplug my hard-drive and have everything with me. At work, I don’t have to
bring my own hard drive with me – they have their own one <code>:p</code> with an equal script
which can be triggered from time to time.</p>

]]></content>
  </entry>
  
</feed>
